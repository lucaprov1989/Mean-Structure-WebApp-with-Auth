angular.module("app.config",[]).constant("config",{endpoint:"http://localhost:4000/api",client_id:"loginclient",client_secret:"tornosubito"}),angular.module("AppControllers").controller("LoginCtrl",["$scope","$location","$localStorage","$sessionStorage","$rootScope","RestClient",function($scope,$location,$localStorage,$sessionStorage,$rootScope,RestClient){function redirectUser(){RestClient.current_user(function(response){switch($sessionStorage.user=response.data,$sessionStorage.user._type){case"Candidato":$rootScope.goTo("");break;case"Valutatore":$rootScope.goTo("valutazione");break;case"Backoffice":$rootScope.goTo("valutazione");break;case"RUP":$rootScope.goTo("valutazione");break;default:$location.path("/")}})}return null!==$localStorage.accessToken&&void 0!==$sessionStorage.user?void redirectUser():void($scope.login=function(){$scope.loginerror="",RestClient.login($scope.user,function(response){switch(console.log(response),response.error){case 0:$localStorage.accessToken=response.data,$localStorage.accessToken.time=new Date,console.log($localStorage.accessToken),$rootScope.goTo("");
//redirectUser();
break;case 403:$scope.loginerror="Accesso errato, verificare i dati inseriti";break;default:$scope.loginerror="Assenza di connessione o connessi da una rete aziendale. Verificare la connessione."}})})}]),angular.module("app.proxy",[]).factory("RestClient",["$http","config","$localStorage","$filter","$rootScope","$httpParamSerializer","$base64",function($http,config,$localStorage,$filter,$rootScope,$httpParamSerializer,$base64){function Poll(){if(null!==$localStorage.accessToken){var diff=((new Date).getTime()-lastPolling.getTime())/1e3;console.log("Polling diff:"+diff),diff>1800&&(getRequest("/utente/_",function(response){void 0!==response.data&&null!==response.data&&$rootScope.polled(response.data)}),lastPolling=new Date)}}function getResponse(response){return{error:200==response.status?0:response.status,description:response.statusText,data:response.data}}function makeRequest(req,callBack){if(
// Si mostra lo spinner
$rootScope.NET_STATUS_ON=!0,null!==$localStorage.accessToken&&void 0!=$localStorage.accessToken&&(void 0===req.data||void 0!==req.data&&/*req.data.indexOf("grant_type") === -1*/void 0===req.data.grant_type)){req.headers={Authorization:"Bearer "+$localStorage.accessToken.access_token._id},console.log("AccessToken: check expire time");var diff=((new Date).getTime()-new Date($localStorage.accessToken.time).getTime())/1e3;if(diff>$localStorage.accessToken.expires_in-300){console.log("Token is expiring... Refreshing");var rp={grant_type:"refresh_token",client_id:config.client_id,client_secret:config.client_secret,refresh_token:$localStorage.accessToken.refresh_token};
//$localStorage.accessToken = null;
return void postRequest("/oauth2/token",rp,function(response){$localStorage.accessToken=response.data,$localStorage.accessToken.time=new Date,makeRequest(req,callBack)})}}$http(req).then(function(response){$rootScope.NET_STATUS_ON=!1,void 0!==callBack?(callBack(getResponse(response)),
// Polling per nuove notifiche
Poll()):(console.log("PostRequestSuccess: "+req.url+"?"+$httpParamSerializer(rp)),console.log(response))},function(response){$rootScope.NET_STATUS_ON=!1,void 0!==callBack?(callBack(getResponse(response)),
// Polling per nuove notifiche
Poll()):(console.error("PostRequestError: "+req.url+"?"+$httpParamSerializer(rp)),console.error(response))})}function dataRequest(method,path,rp,callBack){var req={method:method,url:config.endpoint+path,data:rp};void 0!==rp.client_id&&void 0!==rp.client_secret&&(req.headers={Authorization:"Basic "+$base64.encode(rp.client_id+":"+rp.client_secret)},delete rp.client_id,delete rp.client_secret,req.data=rp),"/public/recover"==path&&(req.headers={Authorization:"Bearer 4ryzU7ltSUtrNqmNsKKEbXvf8V0XsUDAGC9J2U9g3zYGPwMeSytjTRjuEB7z25ji"}),makeRequest(req,callBack)}function queryRequest(method,path,callBack){var req={method:method,url:config.endpoint+path};makeRequest(req,callBack)}function postRequest(path,rp,callBack){dataRequest("POST",path,rp,callBack)}function getRequest(path,callBack){queryRequest("GET",path,callBack)}var lastPolling=new Date;return $rootScope.NET_STATUS_ON=!1,{login:function(user,callBack){var rp={grant_type:"password",client_id:config.client_id,client_secret:config.client_secret,username:user.name,password:user.password};postRequest("/oauth2/token",rp,callBack)},current_user:function(callBack){getRequest("/utente",callBack)}}}]);var APP=angular.module("GestionaleLogin",["ngRoute","ngMaterial","ngStorage","templates-webapp","app.config","app.proxy","AppControllers","base64","a8m.chunk-by"]);APP.config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{templateUrl:"pages/login.html",controller:"LoginCtrl"})}]),APP.run(["$rootScope","$location","$localStorage","$sessionStorage","$mdToast","RestClient","$window",function($rootScope,$location,$localStorage,$sessionStorage,$mdToast,RestClient,$window){$rootScope.auth=function(callBack){
// Check access token
if($location.path().indexOf("search")==-1&&($rootScope.search=""),null===$localStorage.accessToken||void 0===$localStorage.accessToken)return void $location.path("/login");
// Check expire time
var diff=(new Date).getTime()-new Date($localStorage.accessToken.access_token.expire_time).getTime();return diff>0?($localStorage.accessToken=null,void $location.path("/login")):(console.log("Authenticated"),console.log($localStorage.accessToken),void(null===$sessionStorage.user||void 0===$sessionStorage.user?RestClient.current_user(function(response){$rootScope.User=$sessionStorage.user=response.data,callBack()}):($rootScope.User=$sessionStorage.user,console.log($rootScope.User),callBack())))},$rootScope.goTo=function(p){if("/"==p.charAt(0))$location.path(p);else{var url=$location.protocol()+"://"+$location.host();80!=$location.port()&&(url+=":"+$location.port()),url+="/",""!=p&&(url+=p+"/"),$window.location.href=url}},$rootScope.search="",$rootScope.doSearch=function(){
//$rootScope.search
$location.path().indexOf("search")==-1&&$location.path("/search")},$rootScope.showToast=function(message){$mdToast.show($mdToast.simple().content(message).position("bottom right").hideDelay(3e3))},$rootScope.logout=function(){$localStorage.accessToken=null,$sessionStorage.user=null,$location.path("/login")}}]),APP.controller("TopToolBarCtrl",["$scope","$location",function($scope,$location){$scope.isLogin=function(){return!(1==$location.path().indexOf("login"))}}]),/* FILTRI CUSTOM */
APP.filter("filterAttivita",["filterWatcher",function(filterWatcher){return function(array){return void 0===array?[]:filterWatcher.isMemoized("filterAttivita",arguments)||filterWatcher.memoize("filterAttivita",arguments,this,_filterAttivita(array))}}]),APP.filter("filterRichiesta",function(){return function(richiesta,outType){}}),APP.directive("statoRichiesta",function(){return{restrict:"E",scope:{richiesta:"="},templateUrl:function(elem,attr){return"directive/stato-richiesta/"+attr.tipo+".html"}}}),APP.filter("filterPagamenti",["filterWatcher",function(filterWatcher){return function(array){return void 0===array?[]:filterWatcher.isMemoized("filterPagamenti",arguments)||filterWatcher.memoize("filterPagamenti",arguments,this,_filterPagamenti(array))}}]),APP.directive("uiJqvmap",[function(){return{restrict:"A",scope:{options:"="},link:function(scope,ele){var options;return options=scope.options,jQuery(ele).vectorMap(options)}}}]);