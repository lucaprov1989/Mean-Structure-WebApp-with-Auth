angular.module("app.config",[]).constant("config",{endpoint:"http://localhost:4000/api",client_id:"loginclient",client_secret:"tornosubito"}),angular.module("AppControllers",[]).controller("IndexCtrl",["$scope","$location","$localStorage","$sessionStorage","$rootScope","RestClient","$window",function($scope,$location,$localStorage,$sessionStorage,$rootScope,RestClient,$window){}]),angular.module("app.proxy",[]).factory("RestClient",["$http","config","$localStorage","$filter","$rootScope","$httpParamSerializer","$base64",function($http,config,$localStorage,$filter,$rootScope,$httpParamSerializer,$base64){function Poll(){if(null!==$localStorage.accessToken){var diff=((new Date).getTime()-lastPolling.getTime())/1e3;console.log("Polling diff:"+diff),diff>1800&&(getRequest("/utente/_",function(response){void 0!==response.data&&null!==response.data&&$rootScope.polled(response.data)}),lastPolling=new Date)}}function verifyDateUpload(object){for(var attr in object){var attribute=object[attr];if(null!=attribute)switch(typeof attribute){case"object":if(attribute.getFullYear){var month=attribute.getMonth()+1;month<10&&(month="0"+month);var day=attribute.getDate();day<10&&(day="0"+day),object[attr]=attribute.getFullYear()+"-"+month+"-"+day+"T00:00:00.000Z"}else verifyDateUpload(attribute)}}}function getResponse(response){return{error:200==response.status?0:response.status,description:response.statusText,data:response.data}}function makeRequest(req,callBack){if($rootScope.NET_STATUS_ON=!0,null!==$localStorage.accessToken&&void 0!=$localStorage.accessToken&&(void 0===req.data||void 0!==req.data&&void 0===req.data.grant_type)&&void 0===req.headers&&(req.headers={Authorization:"Bearer "+$localStorage.accessToken.access_token._id},console.log("AccessToken: check expire time"),((new Date).getTime()-new Date($localStorage.accessToken.time).getTime())/1e3>$localStorage.accessToken.expires_in-300)){console.log("Token is expiring... Refreshing");var rp={grant_type:"refresh_token",client_id:config.client_id,client_secret:config.client_secret,refresh_token:$localStorage.accessToken.refresh_token};postRequest("/oauth2/token",rp,function(response){$localStorage.accessToken=response.data,$localStorage.accessToken.time=new Date,makeRequest(req,callBack)})}else $http(req).then(function(response){$rootScope.NET_STATUS_ON=!1,void 0!==callBack?(callBack(getResponse(response)),Poll()):(console.log("PostRequestSuccess: "+req.url+"?"+$httpParamSerializer(rp)),console.log(response))},function(response){$rootScope.NET_STATUS_ON=!1,void 0!==callBack?(callBack(getResponse(response)),Poll()):(console.error("PostRequestError: "+req.url+"?"+$httpParamSerializer(rp)),console.error(response))})}function dataRequest(method,path,rp,callBack){verifyDateUpload(rp);var req={method:method,url:config.endpoint+path,data:rp};void 0!==rp.client_id&&void 0!==rp.client_secret&&(req.headers={Authorization:"Basic "+$base64.encode(rp.client_id+":"+rp.client_secret)},delete rp.client_id,delete rp.client_secret,req.data=rp),"/public/register"==path&&(req.headers={Authorization:"Bearer 4ryzU7ltSUtrNqmNsKKEbXvf8V0XsUDAGC9J2U9g3zYGPwMeSytjTRjuEB7z25ji"}),makeRequest(req,callBack)}function queryRequest(method,path,callBack){makeRequest({method:method,url:config.endpoint+path},callBack)}function postRequest(path,rp,callBack){dataRequest("POST",path,rp,callBack)}function getRequest(path,callBack){queryRequest("GET",path,callBack)}var lastPolling=new Date;return $rootScope.NET_STATUS_ON=!1,{current_user:function(callBack){getRequest("/utente",callBack)}}}]);var APP=angular.module("GestionaleLogin",["ngRoute","ngMaterial","ngStorage","templates-webapp","app.config","app.proxy","angularFileUpload","AppControllers","base64","a8m.chunk-by","ngSanitize"]);APP.config(["$routeProvider","$mdDateLocaleProvider",function($routeProvider,$mdDateLocaleProvider){$routeProvider.when("/",{templateUrl:"gestionale2/pages/index.html",controller:"IndexCtrl"}).otherwise({redirectTo:"/404"}),$mdDateLocaleProvider.months=["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"],$mdDateLocaleProvider.shortMonths=["gen","feb","mar","apr","mag","giu","lug","ago","set","ott","nov","dic"],$mdDateLocaleProvider.days=["domenica","lunedì","martedì","mercoledì","giovedì","venerdì","sabato"],$mdDateLocaleProvider.shortDays=["dom","lun","mar","mer","gio","ven","sab"],$mdDateLocaleProvider.firstDayOfWeek=1,$mdDateLocaleProvider.parseDate=function(dateString){var dateParts=dateString.split("/");if(3==dateParts.length){var day=parseInt(dateParts[0]),mnt=parseInt(dateParts[1]),yer=parseInt(dateParts[2]);if(!isNaN(day)&&!isNaN(mnt)&&!isNaN(yer))return new Date(yer,mnt-1,day)}return new Date(NaN)},$mdDateLocaleProvider.formatDate=function(date){if(void 0==date)return"";var day=date.getDate()+"",monthIndex=date.getMonth()+1+"",year=date.getFullYear();return"00".substring(0,"00".length-day.length)+day+"/"+("00".substring(0,"00".length-monthIndex.length)+monthIndex)+"/"+year},$mdDateLocaleProvider.monthHeaderFormatter=function(date){return $mdDateLocaleProvider.shortMonths[date.getMonth()]+" "+date.getFullYear()},$mdDateLocaleProvider.weekNumberFormatter=function(weekNumber){return"Settimana "+weekNumber},$mdDateLocaleProvider.msgCalendar="Calendario",$mdDateLocaleProvider.msgOpenCalendar="Apri il calendario"}]),APP.run(["$rootScope","$location","$localStorage","$sessionStorage","$mdToast","RestClient","$window","config",function($rootScope,$location,$localStorage,$sessionStorage,$mdToast,RestClient,$window,config){$rootScope.auth=function(callBack){if(-1==$location.path().indexOf("search")&&($rootScope.search=""),null!==$localStorage.accessToken&&void 0!==$localStorage.accessToken){if((new Date).getTime()-new Date($localStorage.accessToken.access_token.expire_time).getTime()>0)return $localStorage.accessToken=null,void $location.path("/login");console.log("Authenticated"),console.log($localStorage.accessToken),null===$sessionStorage.user||void 0===$sessionStorage.user?RestClient.current_user(function(response){$rootScope.User=$sessionStorage.user=response.data,callBack()}):($rootScope.User=$sessionStorage.user,console.log($rootScope.User),callBack())}else $location.path("/login")},$rootScope.goTo=function(p){if("/"==p.charAt(0))$location.path(p);else{var url=$location.protocol()+"://"+$location.host();80!=$location.port()&&(url+=":"+$location.port()),url+="/"+p+"/",$window.location.href=url}},$rootScope.search="",$rootScope.doSearch=function(){-1==$location.path().indexOf("search")&&$location.path("/search")},$rootScope.verifyDate=function(object){for(var attr in object){var attribute=object[attr];switch(typeof attribute){case"string":var iso=/^(\d{4})(?:-?W(\d+)(?:-?(\d+)D?)?|(?:-(\d+))?-(\d+))(?:[T ](\d+):(\d+)(?::(\d+)(?:\.(\d+))?)?)?(?:Z(-?\d*))?$/;null!=attribute.match(iso)&&(object[attr]=new Date(attribute));break;case"object":$rootScope.verifyDate(attribute)}}},$rootScope.showToast=function(message){$mdToast.show($mdToast.simple().content(message).position("bottom right").hideDelay(3e3))},$rootScope.logout=function(){$localStorage.accessToken=null,$sessionStorage.user=null,$rootScope.goTo("")}}]),APP.controller("TopToolBarCtrl",["$scope","$location","$localStorage","$sessionStorage",function($scope,$location,$localStorage,$sessionStorage){$scope.isLogin=function(){return null!=$localStorage.accessToken||null!=$sessionStorage.user}}]),APP.filter("filterAttivita",["filterWatcher",function(filterWatcher){return function(array){return void 0===array?[]:filterWatcher.isMemoized("filterAttivita",arguments)||filterWatcher.memoize("filterAttivita",arguments,this,_filterAttivita(array))}}]),APP.filter("filterRichiesta",function(){return function(richiesta,outType){}}),APP.directive("statoRichiesta",function(){return{restrict:"E",scope:{richiesta:"="},templateUrl:function(elem,attr){return"directive/stato-richiesta/"+attr.tipo+".html"}}}),APP.filter("filterPagamenti",["filterWatcher",function(filterWatcher){return function(array){return void 0===array?[]:filterWatcher.isMemoized("filterPagamenti",arguments)||filterWatcher.memoize("filterPagamenti",arguments,this,_filterPagamenti(array))}}]),APP.directive("uiJqvmap",[function(){return{restrict:"A",scope:{options:"="},link:function(scope,ele){var options;return options=scope.options,jQuery(ele).vectorMap(options)}}}]),APP.directive("numbersOnly",function(){return{require:"ngModel",link:function(scope,element,attr,ngModelCtrl){ngModelCtrl.$parsers.push(function(text){if(text){var transformedInput=text.replace(/[^0-9]/g,"");return transformedInput!==text&&(ngModelCtrl.$setViewValue(transformedInput),ngModelCtrl.$render()),transformedInput}})}}});