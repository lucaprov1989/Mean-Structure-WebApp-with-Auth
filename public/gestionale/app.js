angular.module("app.config",[]).constant("config",{endpoint:"http://localhost:4000/api",client_id:"webclient",client_secret:"gestionale"}),angular.module("AppControllers",[]).controller("HomeCtrl",["$rootScope","RestClient","$scope","$localStorage","$window","config","$mdDialog","$location",function($rootScope,RestClient,$scope,$localStorage,$window,config,$mdDialog,$location){$rootScope.auth(function(){})}]),angular.module("app.proxy",[]).factory("RestClient",["$http","config","$localStorage","$filter","$rootScope","$httpParamSerializer","$base64",function($http,config,$localStorage,$filter,$rootScope,$httpParamSerializer,$base64){function Poll(){if(null!==$localStorage.accessToken){var diff=((new Date).getTime()-lastPolling.getTime())/1e3;console.log("Polling diff:"+diff),diff>1800&&(getRequest("/utente/_",function(response){void 0!==response.data&&null!==response.data&&$rootScope.polled(response.data)}),lastPolling=new Date)}}function getResponse(response){return{error:200==response.status?0:response.status,description:response.statusText,data:response.data}}function verifyDateUpload(object){for(var attr in object){var attribute=object[attr];if(null!=attribute)switch(typeof attribute){case"object":if(attribute.getFullYear){var month=attribute.getMonth()+1;month<10&&(month="0"+month);var day=attribute.getDate();day<10&&(day="0"+day),object[attr]=attribute.getFullYear()+"-"+month+"-"+day+"T00:00:00.000Z"}else verifyDateUpload(attribute)}}}function makeRequest(req,callBack){if(
// Si mostra lo spinner
$rootScope.NET_STATUS_ON=!0,null!==$localStorage.accessToken&&void 0!=$localStorage.accessToken&&(void 0===req.data||void 0!==req.data&&/*req.data.indexOf("grant_type") === -1*/void 0===req.data.grant_type)){req.headers={Authorization:"Bearer "+$localStorage.accessToken.access_token._id},console.log("AccessToken: check expire time");var diff=((new Date).getTime()-new Date($localStorage.accessToken.time).getTime())/1e3;if(diff>$localStorage.accessToken.expires_in-300){console.log("Token is expiring... Refreshing");var rp={grant_type:"refresh_token",client_id:config.client_id,client_secret:config.client_secret,refresh_token:$localStorage.accessToken.refresh_token};
//$localStorage.accessToken = null;
return void postRequest("/oauth2/token",rp,function(response){$localStorage.accessToken=response.data,$localStorage.accessToken.time=new Date,makeRequest(req,callBack)})}}$http(req).then(function(response){$rootScope.NET_STATUS_ON=!1,void 0!==callBack?(callBack(getResponse(response)),
// Polling per nuove notifiche
Poll()):(console.log("PostRequestSuccess: "+req.url+"?"+$httpParamSerializer(rp)),console.log(response))},function(response){$rootScope.NET_STATUS_ON=!1,void 0!==callBack?(callBack(getResponse(response)),
// Polling per nuove notifiche
Poll()):(console.error("PostRequestError: "+req.url+"?"+$httpParamSerializer(rp)),console.error(response))})}function dataRequest(method,path,rp,callBack){verifyDateUpload(rp);var req={method:method,url:config.endpoint+path,data:rp};void 0!==rp.client_id&&void 0!==rp.client_secret&&(req.headers={Authorization:"Basic "+$base64.encode(rp.client_id+":"+rp.client_secret)},delete rp.client_id,delete rp.client_secret,req.data=rp),makeRequest(req,callBack)}function queryRequest(method,path,callBack){var req={method:method,url:config.endpoint+path};makeRequest(req,callBack)}function postRequest(path,rp,callBack){dataRequest("POST",path,rp,callBack)}function getRequest(path,callBack){queryRequest("GET",path,callBack)}var lastPolling=new Date;return $rootScope.NET_STATUS_ON=!1,{login:function(user,callBack){var rp={grant_type:"password",client_id:config.client_id,client_secret:config.client_secret,username:user.name,password:user.password};postRequest("/oauth2/token",rp,callBack)},current_user:function(callBack){getRequest("/utente",callBack)},area_riservata:function(callBack){getRequest("/area_riservata",callBack)}}}]);var APP=angular.module("Gestionale",["ngRoute","ngMaterial","ngStorage","chart.js","templates-webapp","app.config","app.proxy","angularFileUpload","AppControllers","base64","a8m.chunk-by"]);APP.config(["$routeProvider","$mdDateLocaleProvider",function($routeProvider,$mdDateLocaleProvider){$routeProvider.when("/",{templateUrl:"pages/home.html",controller:"HomeCtrl"}).when("/login",{templateUrl:"pages/login.html",controller:"LoginCtrl"}).when("/user/:id/:tab?",{templateUrl:"pages/user.html",controller:"UserCtrl"}).otherwise({redirectTo:"/404"}),$mdDateLocaleProvider.months=["gennaio","febbraio","marzo","aprile","maggio","giugno","luglio","agosto","settembre","ottobre","novembre","dicembre"],$mdDateLocaleProvider.shortMonths=["gen","feb","mar","apr","mag","giu","lug","ago","set","ott","nov","dic"],$mdDateLocaleProvider.days=["domenica","lunedì","martedì","mercoledì","giovedì","venerdì","sabato"],$mdDateLocaleProvider.shortDays=["dom","lun","mar","mer","gio","ven","sab"],
// Can change week display to start on Monday.
$mdDateLocaleProvider.firstDayOfWeek=1,
// Optional.
//$mdDateLocaleProvider.dates = [1, 2, 3, 4, 5, 6, ...];
// Example uses moment.js to parse and format dates.
$mdDateLocaleProvider.parseDate=function(dateString){
//console.log('parseDate: ' + dateString);
var dateParts=dateString.split("/");if(3==dateParts.length){var day=parseInt(dateParts[0]),mnt=parseInt(dateParts[1]),yer=parseInt(dateParts[2]);if(!isNaN(day)&&!isNaN(mnt)&&!isNaN(yer))return new Date(yer,mnt-1,day)}return new Date(NaN)},$mdDateLocaleProvider.formatDate=function(date){if(void 0==date)return"";"string"==typeof date&&(date=new Date(date));var day=date.getDate()+"",monthIndex=date.getMonth()+1+"",year=date.getFullYear(),pad="00";return pad.substring(0,pad.length-day.length)+day+"/"+(pad.substring(0,pad.length-monthIndex.length)+monthIndex)+"/"+year},$mdDateLocaleProvider.monthHeaderFormatter=function(date){return $mdDateLocaleProvider.shortMonths[date.getMonth()]+" "+date.getFullYear()},
// In addition to date display, date components also need localized messages
// for aria-labels for screen-reader users.
$mdDateLocaleProvider.weekNumberFormatter=function(weekNumber){return"Settimana "+weekNumber},$mdDateLocaleProvider.msgCalendar="Calendario",$mdDateLocaleProvider.msgOpenCalendar="Apri il calendario"}]),APP.run(["$rootScope","$location","$localStorage","$sessionStorage","$mdToast","RestClient",function($rootScope,$location,$localStorage,$sessionStorage,$mdToast,RestClient){$rootScope.auth=function(callBack){
// Check access token
if($location.path().indexOf("search")==-1&&($rootScope.search=""),null===$localStorage.accessToken||void 0===$localStorage.accessToken)return void $location.path("/login");
// Check expire time
var diff=(new Date).getTime()-new Date($localStorage.accessToken.access_token.expire_time).getTime();return diff>0?($localStorage.accessToken=null,void $location.path("/login")):(console.log("Authenticated"),console.log($localStorage.accessToken),void(null===$sessionStorage.user||void 0===$sessionStorage.user?RestClient.current_user(function(response){$rootScope.User=$sessionStorage.user=response.data,callBack()}):($rootScope.User=$sessionStorage.user,console.log($rootScope.User),callBack())))},$rootScope.goTo=function(p){$location.path(p)},$rootScope.search="",$rootScope.doSearch=function(){
//$rootScope.search
$location.path().indexOf("search")==-1&&$location.path("/search")},$rootScope.showToast=function(message){$mdToast.show($mdToast.simple().content(message).position("bottom right").hideDelay(3e3))},$rootScope.logout=function(){$localStorage.accessToken=null,$sessionStorage.user=null,$location.path("/login")},$rootScope.verifyDate=function(object){for(var attr in object){var attribute=object[attr];switch(typeof attribute){case"string":var iso=/^(\d{4})(?:-?W(\d+)(?:-?(\d+)D?)?|(?:-(\d+))?-(\d+))(?:[T ](\d+):(\d+)(?::(\d+)(?:\.(\d+))?)?)?(?:Z(-?\d*))?$/,parts=attribute.match(iso);
//if(!isNaN(Date.parse(attribute)) && attr != "codice")
null!=parts&&(object[attr]=new Date(attribute));break;case"object":$rootScope.verifyDate(attribute)}}},$rootScope.openMenu=function($mdOpenMenu,ev){$mdOpenMenu(ev)}}]),APP.controller("TopToolBarCtrl",["$scope","$location",function($scope,$location){$scope.isLogin=function(){return!(1==$location.path().indexOf("login"))}}]),/* FILTRI CUSTOM */
APP.filter("filterAttivita",["filterWatcher",function(filterWatcher){return function(array){return void 0===array?[]:filterWatcher.isMemoized("filterAttivita",arguments)||filterWatcher.memoize("filterAttivita",arguments,this,_filterAttivita(array))}}]),APP.filter("filterRichiesta",function(){return function(richiesta,outType){}}),APP.directive("statoRichiesta",function(){return{restrict:"E",scope:{richiesta:"="},templateUrl:function(elem,attr){return"directive/stato-richiesta/"+attr.tipo+".html"}}}),APP.filter("filterPagamenti",["filterWatcher",function(filterWatcher){return function(array){return void 0===array?[]:filterWatcher.isMemoized("filterPagamenti",arguments)||filterWatcher.memoize("filterPagamenti",arguments,this,_filterPagamenti(array))}}]),APP.directive("uiJqvmap",[function(){return{restrict:"A",scope:{options:"="},link:function(scope,ele){var options;return options=scope.options,jQuery(ele).vectorMap(options)}}}]);